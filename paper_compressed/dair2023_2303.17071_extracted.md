## Abstract

Large language models (LLMs) have emerged as valuable tools for many natural language understanding tasks. In safety-critical applications such as healthcare, the utility of these models is governed by their ability to generate outputs that are factually accurate and complete. In this work, we present dialogenabled resolving agents (DERA). DERA is a paradigm made possible by the increased conversational abilities of LLMs, namely GPT4. It provides a simple, interpretable forum for models to communicate feedback and iteratively improve output. We frame our dialog as a discussion between two agent types a Researcher , who processes information and identifies crucial problem components, and a Decider , who has the autonomy to integrate the Researcher 's information and makes judgments on the final output.

We test DERA against three clinically-focused tasks. For medical conversation summarization and care plan generation, DERA shows significant improvement over the base GPT4 performance in both human expert preference evaluations and quantitative metrics. In a new finding, we also show that GPT-4's performance (70%) on an open-ended version of the MedQA question-answering (QA) dataset (Jin et al. (2021), USMLE) is well above the passing level (60%), with DERA showing similar performance. We release the open-ended MEDQA dataset at https://github.com/ curai/curai-research/tree/main/DERA .

## 1 Introduction

Large language models (LLMs; Brown et al. (2020); Lewis et al. (2020)) are deep-learning models that have been trained to predict natural language text conditioned on an input. The use of these models has led to advances in natural language performance far beyond just language mod-

eling tasks. Within the realm of medicine, LLMpowered methods have shown improvements in medical tasks such as question answering (Singhal et al., 2022; Liévin et al., 2022), information extraction (Agrawal et al., 2022), and summarization (Chintagunta et al., 2021).

LLM-powered methods use natural language instructions called prompts . These instruction sets often include a task definition, rules the predictions must follow, and optionally some examples of the task input and output (Reynolds and McDonell, 2021; Brown et al., 2020). The ability of generative language models to create output based on natural language instructions (or prompts) removes the need for task-specific training (Min et al., 2022) and allows non-experts to build upon this technology.

While many tasks can be formulated as a single prompt, later work has shown that breaking down single tasks into sub-tasks (called chaining ) has benefits in terms of task performance and interpretability (Wu et al., 2022). Examples of chaining strategies include chain-of-thought (Wei et al., 2022) and other task-specific approaches ( e.g, Agrawal et al. (2022)). Chain-of-thought strategies prompt the model to think through a problem as an expert might approach it, leading to improvements in some tasks (Liévin et al., 2022; Wang et al., 2022; Tafjord et al., 2022).

All of these approaches attempt to coerce the correct generation from the base language model. However, one fundamental limitation of this strategy is that these prompting architectures are restricted to a fixed set of prompts designed for specific tasks in mind, such as writing explanations or resolving anomalies within the output. Furthermore, they struggle with generating factually accurate text and often can include hallucinations and omissions (Maynez et al., 2020; Dziri et al., 2022; Berezin and Batura, 2022). This poses a significant hurdle when applying them to real-world scenarios,

Figure 1: Overview of DERA. The method consists of two agents-a Researcher and a Decider . The Decider generates an initial output for the task (step 1). Then, the Decider and Researcher work through the problem via conversation (step 2), with the Researcher tasked to help identify crucial problem components. The Decider has the autonomy to integrate the Researcher 's inputs and makes judgments on the final output (step 3). Neither agent has knowledge of the ideal final output.

<!-- image -->

especially in the clinical domain.

We advocate for a different approach that has two essential elements. First, it consists of an iterative approach to refining the initial output. This allows the generation to be refined holistically as opposed to conditional chaining. Second, it includes an advisor that can guide by suggesting areas to focus on in each iteration, adding interpretability to the process. With the advent of GPT-4 (OpenAI, 2023) capable of robust, realistic conversation, we can use dialog as the medium for interaction.

We propose DERA: Dialog-Enabled Resolving Agents. DERA is a framework to explore how we can improve performance on natural language tasks using agents tasked with resolving (or improving) the output through dialog. We propose that scoping each agent in the dialog to a specific role will better enable them to focus on discrete portions of the task, and ensure their partner agent stays aligned with the overall goal. One agent role, the Researcher , works to identify relevant information for the problem and suggest areas of focus to the other agent. Another agent role, the Decider , has the autonomy to react to that information and make final decisions about the output.

Our paper makes the following contributions:

- · We introduce DERA (§ 2) - a framework for agent-agent dialog to improve performance

on natural language tasks.

- · We evaluate DERA on three different types of clinical tasks. Each of these requires different types of textual inputs and types of knowledge to solve.
- -The medical conversation summarization task (§ 3) focuses on generating a summary of a doctor-patient chat that is factually accurate without omissions or hallucinations.
- -The careplan generation task (§4) is knowledge-intensive with long outputs that are useful in clinical decision support. There is not a single best answer to the task and the goal is to maximize the amount of factually accurate and relevant information generated.
- -Medical question answering (Jin et al., 2021) is a knowledge reasoning task with a single answer but posed as an openended task without access to multiple choices. We study in this harder setting using two question-answering datasets (§5).
- · In both human-annotated evaluations, we find that DERA outperforms base GPT-4 performance in the careplan generation and medical

conversation summarization tasks on a variety of metrics. In quantitative evaluations, we find that DERA successfully corrects medical conversation summaries with large amounts of errors. Conversely, we find small to no improvement between GPT-4 performance and DERA on question-answering.

- · We theorize this approach is well suited for longer-form generation tasks, in which there are a lot of fine-grained details.
- · We will work to release a new open-ended medical question-answering task based on MedQA, which consists of United States Medical Licensing Exam (USMLE) practice questions 1 . This opens up new research in the modeling and evaluation of question-answering systems.

## 2 DERA: Overview

DERA is a general chat framework that leverages dialog-capable agents to iteratively work through a task (Figure 1). We focus on agent setups that work to probe knowledge sources, whether internal (from within GPT-4) or external (from text, documents, etc.). In approaches like chain-of-thought, these roles are generally performed jointly. In contrast, we propose that pairing an information-focused agent with a decision-maker agent will lead to a higher-quality output. Furthermore, this approach allows for DERA to alternate between processing knowledge and acting upon them, as opposed to doing them concurrently.

First, we propose the use of a Researcher agent. The goal of a researcher agent is to review pieces of information - which can be internal to GPT-4 or external - and make suggestions on what is likely to be crucial in solving the problem. As we do not have a definitive source of what is and is not relevant, we rely on GPT-4's ability to identify relevancy in light of the current task. We do not treat this agent as the definitive source of truth. Rather, we task it with being helpful and constructive during the dialog.

Second, we propose the use of a Decider agent. In addition to starting the conversation, this agent is tasked with responding to the information provided by the Researcher agent, and deciding whether to integrate that information into the task output. This

allows GPT-4 to make discrete decisions in reaction to the information highlighted by the Researcher . At no point, however, does the Decider defer to the Researcher . This agent is ultimately responsible for the final decision, and while it is tasked with reviewing all information highlighted by Researcher , it does not have to use any of that information.

The specifics of each agent can vary for different tasks. For Question Answering, the Researcher is tasked with pulling information from the question, using the internal knowledge of GPT-4 alone. For summarization, the Researcher has access to external texts which contain the full patient encounter. Conversely, the edits to the text generation task are made incrementally by the Decider in the summarization task, while they are made more discretely in the question-answering task. In some settings, agents take a hybrid role, where they each have access to different information and jointly make decisions. Overall, the goal remains the same that this approach allows for information to be processed in a manner that is both role-defined and iterative, producing better quality output.

We apply DERA to three natural language generation tasks. The first, medical conversation summarization (§3), probes the ability of DERA to create a summary of a doctor-patient chat. This requires the ability to identify and rewrite medicallyrelevant information in a concise format. The second, care plan generation (§4), tests whether DERA can generate doctor-facing suggestions for potential actions to address patient concerns. This requires similar abilities, with the added challenge of knowing the appropriate next steps for a variety of medical conditions. Finally, medical questionanswering (§5) tests the ability of DERA to generate a wide variety of medical knowledge in a short format.

## 6 Discussion and Conclusion

We introduce a framework for agent-agent dialog called DERA. This approach allows agents to focus on specific roles, reducing the need for an LLM to achieve the correct answer in one or two generations. In this setup, we use two types of agents -Researcher , tasked with reviewing and selecting information, and Decider , tasked with integrating that information into the final output. Both dis-

cuss the problem in a chat format, with the goal of improving the output of GPT-4.

As found in Sections 3 and 4, we find DERA improves the quality of the generated text in a variety of metrics. Importantly, this reduces the number of hallucinations and omissions in the resulting text. This finding is important given the ability of large language models (LLM), in particular GPT-4, to generate text that is fluent but potentially prone to errors. The ability of DERA to identify and correct these hallucinations and omissions is critical when applying these models to real-world scenarios. A key feature is that the same LLM can be harnessed in both roles.

We did not find similar improvements in the question-answering task. As discussed in Section 5, DERA produced little to no improvement over a GPT-4 baseline. We suggest this is due to several factors, including the requirement to generate a single, granular answer. DERA often adds information to an answer, which is not helpful for short text generation. These findings, paired with those discussed above, suggest this method is well-suited for longer-generation tasks.

Furthermore, the chat-based format of DERA allows for increased interpretability when auditing the results. Even though LLMs such as GPT-4 may achieve high performance in zero-shot or one-shot settings, generating long-form explanations does not provide a granular forum for understanding resulting generations. Conversely, the chat-based format allows for discussions that are granular and could be verified by an end user for mistakes.

In the future, this setup could be altered to include human input in the discussion. Alternatively, different problems may dictate the inclusion of different types of agents. Overall, we believe that while LLM-based tools are critical in increasing the quality of natural language performance, additional research is required to ensure they are consistent and auditable.

Finally, we reiterate the need for further research in automated metrics for evaluating LLM output. Human-led qualitative evaluations can provide important insights, but it remains a challenge to measure improvement given the limited tools currently available.

## 7 Limitations

The experiments in this paper were performed using OpenAI's API, mostly using GPT-4 models.

While these models generate text at a higher quality than other previous models, there are still limitations. First, we do not have access to what the model has and has not been trained on. Specifically, we do not know if openly-released datasets, such as MedQA, were included in the training data. Second, we report results using the latest version of GPT-4 available at the time. As OpenAI does not persist models, this may make reproducing results challenging.

While we include a variety of quantitative evaluations, the task of automatically evaluating generated text needs further research. Previous methods, such as BERTScore, use models that are less powerful than GPT-4, yet using GPT-4 to evaluate itself is also potentially problematic. Similarly, evaluations of the ability of DERA to reduce the presence of harmful text in generations are promising, but given the limited amount of harmful content present to begin with, we caution against a broad interpretation of that result.

Another limitation is inherent to clinical text datasets. As stated in Section 3, our evaluations and style of summary and care plan are limited to a patient population specific to a single telehealth service, and may not be applicable to uses for the general population. Several of our evaluation datasets cannot be openly released for data privacy or licensing reasons, yet this is likely true for a broad amount of medically-focused research. Additionally, some other datasets that are openly available cannot be directly used with API-based models (Agrawal et al., 2022), further limiting options. We also acknowledge that while MedQA does probe medical knowledge, it likely does so in a different form than is likely to be applied in a regular clinical setting.

## Final Summary

Demographics and Social Determinants of Health : The patient's specific demographics are not mentioned in the encounter. The patient experiences sinus infections multiple times a year. . .

Patient Intent : The patient seeks care for a sinus infection, which they have identified themselves. They are . . .

Pertinent Positives : The patient has been experiencing sinus infection symptoms since Sunday. Their face is swollen, cheeks hurt, eyelids are swollen, and they have a slight fever at night. The patient can also feel something draining down the back of their throat. They have a history of 3-6 sinus infections a year, with the last one occurring a couple of months ago and being treated with amoxicillin.

Pertinent Unknowns : There are no pertinent unknowns mentioned in this medical encounter.

Pertinent Negatives : The patient has not been vaccinated against COVID-19. Their temperature is currently normal but spikes at night.

Medical History : The patient has a history of seasonal allergies and sinus infections. They typically use an Albuterol inhaler for wheezing due to their allergies causing wheezing in the spring and fall, however they currently do not have one. They have had COVID-19 before. The patient currently uses Tylenol severe sinus medication and ibuprofen to alleviate symptoms.

Figure 6: Medical conversation summarization - Quantitative evaluation: The above is a condensed example taken from our summarization dataset. Starting with the initial chat, we generate an initial summary, which is then corrupted (see red text) using Prompt 2. The DERA dialog generates a scratchpad of edits, which results in the final corrected summary. The quantitative evaluation compares the initial summary with the final summary .

```
1 ----2 Below is a medical encounter between an {age} 3 and {sex} patient and a doctor done over chat. 4 Chief Complaint: "{cc}". 5 ----6 Medical Encounter 7 ----8 {chat} 9 ----10 Summary Instructions 11 ----12 Provide a summary of the medical encounter between the doctor and the {age\_and\_sex} patient in 6 sections (Demographics and Social Determinants of Health , Patient Intent , Pertinent Positives , Pertinent Unknowns , Pertinent Negatives , Medical History). The definitions of each section are listed below. Write a paragraph under each section , not bullet points. 13 14 Demographics and Social Determinants of Health: 15 // Definition of section 16 17 Patient Intent: 18 // Definition of section 19 20 Pertinent Positives: 21 // Definition of section 22 23 Pertinent Unknowns: 24 // Definition of section 25 26 Pertinent Negatives: 27 // Definition of section 28 29 Medical History: 30 // Definition of section 31 32 ----33 Summary of Medical Encounter 34 ----
```

Prompt 1: Prompt for generating initial summary.

```
1 ---2 Below is a medical encounter between a {age\_and\_sex} patient and a doctor done over chat. 3 Chief complaint: "{cc}". 4 ----5 Medical Encounter 6 ----7 {chat} 8 ----9 Below is a summary of the conversation that was written using the following instructions: 10 11 // Definition of medical summary (same as in initial summarization prompt) 12 ----13 Summary of Medical Encounter 14 ----15 {summary} 16 ----17 Using the above dialogue and provided summary , corrupt the summary slightly. This could include moving a positive symptom to be a negative symptom , making up medical history mentioned , etc. 18 19 Corruptions should only occur on the Pertinent Positives , Pertinent Unknowns , Pertinent Negative , or Medical History section. 20 21 The lower the desired corruption level, the fewer the changes made. Note that a 0 would be not changing the summary at all, and a 10 would be completely corrupting the summary. 22 23 Note that any changes/corruption should make the summary less factual. 24 25 Desired Corruption Level: {corruption\_level}/10 26 ----27 Corrupted Summary of Medical Encounter 28 ----
```

Prompt 2: Prompt for generating corruptions based off of the initial summary.

```
1 You (Person A) are a very good summary writer for medical dialogues between physicians and patients. 2 3 This is the medical dialogue you summarized for a {age} and {sex} patient: 4 -Medical Dialogue 5 {chat} 6 -Medical Dialogue 7 8 You are discussing the summary you wrote for this dialogue with another summary writer (Person B) whose job it is to verify your summary for correctness. 9 10 Person B will give you points for correction and it will be your job to add the points of correction to a scratchpad if you agree with them. 11 12 This is your original version of the summary: 13 -Your Original Summary 14 {summary} 15 -Your Original Summary 16 17 Here is your current scratchpad of corrections to make to the summary: 18 -Correction Scratchpad 19 {scratchpad} 20 -Correction Scratchpad 21 22 You are generally very confident about the summary you wrote, however , when presented with compelling arguments by the verifying summary writer , you add to the correction scratchpad. You also suggest any edits of your own in case you notice a mistake. 23 24 This is the summary discussion so far: 25 -Summary Discussion 26 {discussion} 27 -Summary Discussion 28 29 Question: What do you say next? Respond to Person B in the tag [RESPONSE: "< your\_response\_here >"] and output any corrections to add to the scratchpad in the tag [SCRATCHPAD: "<things\_to\_add\_to\_the\_scratchpad\_here >"]. Make sure to use the "[]" when outputting tags. 30 Answer:
```

Prompt 3: Prompt for decider agent used in DERA summarization experiments.

```
1 ---2 You (Person B) are a very good summary editer for medical dialogues between physicians and patients. 3 4 This is the medical dialogue you will be referencing for a {age} and {sex} patient: 5 -Medical Dialogue 6 {chat} 7 -Medical Dialogue 8 9 You are discussing the summary that another summary writer (Person A) wrote for this dialogue one section at a time. 10 11 You will be giving Person A points for correction based on any mistakes/ discrepancies you see between the dialogue and summary one section at a time. Person A will add the points of correction that they agree on to a scratchpad to later make edits. 12 13 However , you will only go through the Pertinent Positives , Pertinent Negatives , Pertinent Unknowns , and Medical History sections. 14 15 This is Person A's original version of the summary: 16 -Person A's Original Summary 17 {summary} 18 -Person A's Original Summary 19 20 Here is Person A's current scratchpad of corrections to make to the summary: 21 -Correction Scratchpad 22 {scratchpad} 23 -Correction Scratchpad 24 25 Go through each section of the summary one at a time and point out any text that does not have a grounding in the dialogue. It must be possible to directly tie any span of the summary to the dialogue. 26 27 Make sure to make accurate , useful suggestions for corrections. 28 29 Person A may not initially agree with you, but if you are confident there is an error do your best to convince Person A of the mistake. 30 31 Once you have gone through each section and have confirmed each section with Person A, and you are satisfied with all of the corrections added to the scratchpad and /or all of Person A's reasoning to reject additional corrections , output the tag "[STOP]". 32 33 This is the summary discussion with Person A so far: 34 -Summary Discussion 35 {discussion} 36 -Summary Discussion 37 38 Question: What do you say next? Respond to Person A in the tag [RESPONSE: "< your\_response\_here >"]. If you are done correcting and are satisfied , output the "[STOP]" tag. 39 Answer:
```

Prompt 4: Prompt for researcher agent used in DERA summarization experiments.

```
1 ---2 You are a very good summary writer for medical dialogues between physicians and patients. 3 4 This is the medical dialogue you summarized for a {age} and {sex} patient: 5 -Medical Dialogue 6 {chat} 7 -Medical Dialogue 8 9 This is your original version of the summary: 10 -Original Summary 11 {summary} 12 -Original Summary 13 14 Here is your current scratchpad of corrections to make to the summary: 15 -Correction Scratchpad 16 {scratchpad} 17 -Correction Scratchpad 18 19 Make all changes mentioned in the scratchpad to the original summary to output the corrected summary. 20 21 Output the tag "[STOP]" when finished writing the corrected summary. 22 23 -Corrected Summary -
```

Prompt 5: Prompt for final summarization step (incorporating scratchpad of corrections into the original summary) used in DERA summarization experiments.

```
1 Given the following snippet of a medical dialogue summary , extract the medical concepts (symptoms , diseases , conditions , allergies , lab tests , etc.) present. 2 3 The heading of the section from which the summary was extracted will also be provided. 4 5 ---Example 1--6 Pertinent Negatives: Patient reports no <concept\_1 >, no <concept\_2 >, <concept\_3 >, and <concept\_4 >. Patient also reports having no trouble with <concept\_5 >. 7 8 Medical Concepts: [<concept\_1 >, <concept\_2 >, <concept\_3 >, <concept\_4 >, <concept\_5 >] 9 ---Example 1--10 11 ---Example 2--12 Pertinent Positives: Patient ongoing <concept\_1 > for the past 5 days, <concept\_2 >, and some <concept\_3 >. Patient had <concept\_4 > done in May 2021. 13 14 Medical Concepts: [<concept\_1 >, <concept\_2 >, <concept\_3 >, <concept\_4 >] 15 ---Example 2--16 17 ---Example 3--18 Pertinent Unknowns: Patient is unsure about <concept\_1 > and <concept\_2 >. 19 20 Medical Concepts: [<concept\_1 >, <concept\_2 >] 21 ---Example 3--22 23 ---Example 4--24 Medical History: Patient reports some <concept\_1 > in the past, and had last < concept\_2 > on DATE\_1. 25 26 Medical Concepts: [<concept\_1 >, <concept\_2 >] 27 ---Example 4--28 29 Here is the example to extract medical concepts from: 30 31 {section\_heading}: {section\_value} 32 33 Medical Concepts:
```

Prompt 6: Prompt for extracting medical concepts from the summary used to compute the GPT-F1 metric.

```
1 Given a snippet (snippet) from a medical dialogue summary and a corresponding list ( list\_a) of medical concepts extracted from that snippet , evaluate what medical concepts from a separate list (list\_b) can be found in either list\_a or snippet. 2 3 Note that on some occasions a medical concept from list\_b may not be found in list\_a , but can be appropriate to be present given the snippet. This could include rephrasings of medical concepts that are clinically equivalent (Ex: COVID and COVID -19). 4 5 ---Example --6 snippet: <snippet > 7 list\_a: [<concept\_1 >, <concept\_2 >, <concept\_3 >, <concept\_4 >, <concept\_5 >, <concept\_7 >] 8 list\_b: [<concept\_0 >, <concept\_1 >, <concept\_3 >, <concept\_4 >, <concept\_5 >, <concept\_6 >] 9 10 found\_b: [<concept\_1 >, <concept\_3 >, <concept\_4 >, <concept\_5 >] 11 not\_found\_b: [<concept\_0 >, <concept\_6 >] 12 13 ---Example --14 15 Here is the snippet , list\_a. Evaluate the medical concepts in list\_b as above. 16 17 snippet: {snippet} 18 list\_a: {list\_a} 19 list\_b: {list\_b} 20 21 found\_b:
```

Prompt 7: Prompt for verifying medical concepts from a summary section used to compute the GPT-F1 metric.

```
1 ----2 Care Plan Instructions 3 ----4 You are a primary care physician tasked with writing a care plan, which lists the next steps in care management that the patient and the physician will perform. 5 Categorize the next steps into five sections: Medications , Referrals , Tests , Lifestyle and Supportive Care. Definitions and scopes of each section are defined below. 6 7 Medications: 8 // Definition of section 9 Referrals: 10 // Definition of section 11 Tests: 12 // Definition of section 13 Lifestyle: 14 // Definition of section 15 Supportive Care: 16 // Definition of section 17 18 {example} 19 ----20 Care Plan Instructions 21 ----22 Now that you've seen an example , you will now write a care plan of the same format ( five sections: Medications , Referrals , Tests , Lifestyle and Supportive Care). 23 24 The dialogue you will use to write a care plan about is a medical encounter between a {age} and {sex} patient and a doctor done over chat: 25 ----26 Dialogue 27 ----28 {chat} 29 ----30 Care Plan 31 ----
```

Prompt 8: Prompt for generating initial care plan

```
1 ---2 You (Person A) are a very good writer of care plans for patients following their discussion with a physician. The full instructions are presented below. 3 ---4 Care Plan Writing Instructions 5 ---6 // Same instructions as in initial care plan generation prompt. Removed for brevity. 7 ---8 Given the instructions , this is the medical dialogue you see for a {{age}} {{sex}} patient: 9 ---10 Medical Dialogue 11 ---12 {chat} 13 ---14 You are discussing the care plan you wrote for this dialogue with another care plan writer (Person B) whose job it is to verify your care plan for soundness. 15 16 Person B will give you points for correction and it will be your job to add the points of correction to a scratchpad if you agree with them. 17 18 This is your original version of the care plan: 19 ---20 Your Original Care Plan 21 ---22 {careplan} 23 ---24 Here is your current scratchpad of corrections to make to the care plan: 25 ---26 Correction Scratchpad 27 ---28 {scratchpad} 29 ---30 You are generally very confident about the care plan you wrote, however , when presented with compelling arguments by the verifying care plan writer , you add to the correction scratchpad. You also suggest any edits of your own in case you notice a mistake. 31 32 This is the care plan discussion so far: 33 ---34 Care Plan Discussion 35 ---36 {discussion} 37 ---38 Question: What do you say next? Respond to Person B in the tag [RESPONSE: "< your\_response\_here >"] and output any corrections to add to the scratchpad in the tag [SCRATCHPAD: "<things\_to\_add\_to\_the\_scratchpad\_here >"]. Make sure to use the "[]" when outputting tags. All text should be within the tag brackets. 39 An example answer would be: [RESPONSE: "I think we should remove ... from the care plan"] [SCRATCHPAD: "Remove ... from the care plan because ..."] 40 ---41 Answer:
```

Prompt 9: Prompt for decider agent used in DERA care plan experiments.

```
1 ---2 You are a primary care physician and very good editor of care plans for patients following their discussion with a physician. The full instructions for writing care plans are presented below. 3 ---4 Care Plan Writing Instructions 5 ---6 // Same instructions as in initial care plan generation prompt. Removed for brevity. 7 ---8 Given the instructions , this is the medical dialogue you see for a {age\_and\_sex} patient: 9 ---10 Medical Dialogue 11 ---12 {chat} 13 ---14 15 You are discussing the care plan that another care plan writer (Person A) wrote for this dialogue one section at a time. 16 17 You will be giving Person A points for correction based on any reconsiderations you see between the dialogue and care plan one section at a time. Person A will add the points of correction that they agree on to a scratchpad to later make edits. 18 19 This is Person A's original version of the care plan: 20 ---21 Person A's Original Care Plan 22 ---23 {careplan} 24 ---25 Here is Person A's current scratchpad of corrections to make to the care plan: 26 ---27 Correction Scratchpad 28 ---29 {scratchpad} 30 ---31 Go through each section of the care plan one section at a time and point out any suggestions that does not have a grounding in the dialogue. All suggestions must be grounded in information from the dialogue. 32 33 Remember to make sure the care plan is congruent with the Care Plan Writing Instructions. 34 35 Make sure to make accurate , useful suggestions for corrections. 36 37 Person A may not initially agree with you, but if you are confident there is an error do your best to convince Person A of the mistake. 38 39 Once you have gone through each section and have confirmed each section with Person A, and you are satisfied with all of the corrections added to the scratchpad and /or all of Person A's reasoning to reject additional corrections , output the tag "[DONE]". 40 41 This is the care plan discussion with Person A so far: 42 ---43 Care Plan Discussion 44 ---45 {discussion} 46 ---47 Question: What do you say next? Respond to Person A in the tag [RESPONSE: "< your\_response\_here >"]. If you are done correcting , are satisfied , and want to end the conversation , output "DONE". 48 ---49 Answer:
```

Prompt 10: Prompt for researcher agent used in DERA care plan experiments.

```
1 ---2 You are a very good writer of care plans for patients following their discussion with a physician. The full instructions are presented below. 3 ---4 Care Plan Writing Instructions 5 ---6 // Same instructions as in initial care plan generation prompt. Removed for brevity. 7 ---8 Given the instructions , this is the medical dialogue you see for a {age} and {sex} patient: 9 ---10 Medical Dialogue 11 ---12 {{chat}} 13 ---14 You have been discussing the care plan you wrote for this dialogue with another care plan writer (Person B) whose job it is to verify your care plan for soundness. 15 16 You added corrections to a scratchpad after discussing them with Person B, and you will later be tasked with updating the original care plan based off of the correctness suggested in the scratchpad. 17 18 This is your original version of the care plan: 19 ---20 Your Original Care Plan 21 ---22 {careplan} 23 ---24 Here is your current scratchpad of corrections to make to the care plan: 25 ---26 Correction Scratchpad 27 ---28 {scratchpad} 29 ---30 Make all changes mentioned in the scratchpad to the original care plan to output the corrected care plan. Make sure all changes are congruent to the Care Plan Writing Instructions. 31 32 Output the tag "[STOP]" when finished writing the corrected care plan. 33 ---34 Corrected Care Plan 35 ---
```

Prompt 11: Prompt for final care plan generation step (incorporating scratchpad of corrections into the original care plan) used in DERA care plan experiments.

1 The following question was written as a multiple choice question. Rewrite it as posing an open-ended question. If it is already an open-ended question and the question requires no rewrite , output "[OPEN]" only. Do not change any details or facts in the question , and only change the phrasing of the question. 2 3 --Example -4 Question: A 60-year-old man comes to the physician for an examination prior to a scheduled cholecystectomy. He has hypertension treated with hydrochlorothiazide. His mother had chronic granulomatous disease of the lung. He works in a glass manufacturing plant. He has smoked two packs of cigarettes daily for 38 years. His vital signs are within normal limits. Examination shows no abnormalities. Laboratory studies are within the reference range. An x-ray of the chest is shown. Which of the following is the most appropriate next step in management? 5 6 Rewrite: A 60-year-old man comes to the physician for an examination prior to a scheduled cholecystectomy. He has hypertension treated with hydrochlorothiazide. His mother had chronic granulomatous disease of the lung. He works in a glass manufacturing plant. He has smoked two packs of cigarettes daily for 38 years. His vital signs are within normal limits. Examination shows no abnormalities. Laboratory studies are within the reference range. An x-ray of the chest is shown. What is the most appropriate next step in management? 7 --Example -8 Question: Several patients at a local US hospital present with chronic secretory diarrhea. Although there are multiple potential causes of diarrhea present in these patients , which of the following is most likely the common cause of their chronic secretory diarrhea? 9 10 Rewrite: Several patients at a local US hospital present with chronic secretory diarrhea. Although there are multiple potential causes of diarrhea present in these patients , what is most likely the common cause of their chronic secretory diarrhea? 11 12 --Example -13 Question: A 39-year-old male presents to your office with nodular skin lesions that progress from his right hand to right shoulder. The patient reports that the initial lesion , currently necrotic and ulcerative , developed from an injury he received while weeding his shrubs a couple weeks earlier. The patient denies symptoms of respiratory or meningeal disease. Which of the following most likely characterizes the pattern of this patient 's skin lesions: 14 15 Rewrite: A 39-year-old male presents to your office with nodular skin lesions that progress from his right hand to right shoulder. The patient reports that the initial lesion , currently necrotic and ulcerative , developed from an injury he received while weeding his shrubs a couple weeks earlier. The patient denies symptoms of respiratory or meningeal disease. How would you characterize the pattern of this patient 's skin lesions? 16 --Example -17 Question: A 71-year-old man presents to the clinic with complaints of right wrist pain for 2 days. On examination , redness and swelling were noted on the dorsal aspect of his right wrist. He had pain with extreme range of motion of the wrist. His history includes 2 hip replacements , 2 previous episodes of gout in both first metatarsophalangeal joints , and hypertension. Two days later, the swelling had increased in the dorsal aspect of his right wrist and hand. Wrist flexion was limited to 80% with severe pain. The pain was present on palpation of the scaphoid bone. Due to the suspicion of fracture , the patient was referred to his general practitioner for radiographs. These findings were consistent with gouty arthritis. What is the most likely cytokine involved in this process? 18

```
19 Rewrite: [OPEN] 20 ---21 Question: {{question}} 22 23 Rewrite:
```

Prompt 12: Prompt for rewriting the question in full (temperature at 0 and otherwise uses default parameters)

```
1 The following question was written as a multiple choice quesiton. For the sentence in the question poses a multiple choice , rewrite it as posing an open-ended question. If the relevant is a compound sentence , re-write the entire sentence. If it is already an open-ended question and the question requires no rewrite , output "[OPEN]" only. Do not change any details or facts in the question , and only change the phrasing of the question. 2 3 --Example -4 Question: A 60-year-old man comes to the physician for an examination prior to a scheduled cholecystectomy. He has hypertension treated with hydrochlorothiazide. His mother had chronic granulomatous disease of the lung. He works in a glass manufacturing plant. He has smoked two packs of cigarettes daily for 38 years. His vital signs are within normal limits. Examination shows no abnormalities. Laboratory studies are within the reference range. An x-ray of the chest is shown. Which of the following is the most appropriate next step in management? 5 6 Original: Which of the following is the most appropriate next step in management? 7 8 Rewrite: What is the most appropriate next step in management? 9 --Example -10 Question: Several patients at a local US hospital present with chronic secretory diarrhea. Although there are multiple potential causes of diarrhea present in these patients , which of the following is most likely the common cause of their chronic secretory diarrhea? 11 12 Original: Although there are multiple potential causes of diarrhea present in these patients , which of the following is most likely the common cause of their chronic secretory diarrhea? 13 14 Rewrite: Although there are multiple potential causes of diarrhea present in these patients , what is most likely the common cause of their chronic secretory diarrhea? 15 --Example -16 Question:A 39-year-old male presents to your office with nodular skin lesions that progress from his right hand to right shoulder. The patient reports that the initial lesion , currently necrotic and ulcerative , developed from an injury he received while weeding his shrubs a couple weeks earlier. The patient denies symptoms of respiratory or meningeal disease. Which of the following most likely characterizes the pattern of this patient 's skin lesions: 17 18 Original: Which of the following most likely characterizes the pattern of this patient 's skin lesions: 19 20 Rewrite: How would you characterize the pattern of this patient 's skin lesions? 21 --Example -22 Question: A 71-year-old man presents to the clinic with complaints of right wrist pain for 2 days. On examination , redness and swelling were noted on the dorsal aspect of his right wrist. He had pain with extreme range of motion of the wrist. His history includes 2 hip replacements , 2 previous episodes of gout in both first metatarsophalangeal joints , and hypertension. Two days later, the swelling had increased in the dorsal aspect of his right wrist and hand. Wrist flexion was limited to 80% with severe pain. The pain was present on palpation of the scaphoid bone. Due to the suspicion of fracture , the patient was referred to his general practitioner for radiographs. These findings were consistent with gouty arthritis. What is the most likely cytokine involved in this process? 23 24 Original: What is the most likely cytokine involved in this process? 25 26 Rewrite: [OPEN] 27 ---28 Question: {{question}} 29 30 Original:
```

Prompt 13: Prompt for rewriting the question by changing the last sentence only (temperature at 0 and otherwise uses default parameters).

```
1 Given the following medical question , respond with the phrase that best answers the question. 2 3 --Example -4 Question: A mother brings her 3-week-old infant to the pediatrician 's office because she is concerned about his feeding habits. He was born without complications and has not had any medical problems up until this time. However , for the past 4 days , he has been fussy , is regurgitating all of his feeds , and his vomit is yellow in color. On physical exam, the child's abdomen is minimally distended but no other abnormalities are appreciated. What embryologic error could account for this presentation? 5 6 What phrase best answers the question posed? 7 8 Answer: Abnormal migration of ventral pancreatic bud 9 ----10 Question: {question} 11 12 What phrase best answers the question posed? 13 14 Answer:
```

Prompt 14: Prompt for generating the single-shot answer.

```
1 {question} 2 3 {options\_filtered\_str} 4 5 You think the relative likelihood of each option is {relative\_likelihood}. Write a 3-4 sentence message explaining why you rate the options in that way, without taking a decisive stand. 6 7 Message:
```

Prompt 15: Prompt for generating the explanation for the single-shot answer distribution.

```
1 You are an expert medical doctor who is guiding a medical student through thinking about which of several answers is best for a given question. You cannot give the student the answer. Your role is to help the student think through the question , specifically by pointing out portions of the question that are important in understanding the problem. 2 Rules; 3 - All responses should include a quote from the question. 4 - Consider what you, as the teacher , have said in the previous conversation , and do not repeat yourself. 5 - Responses should be at most 4 sentences long. 6 - Stop only when you, as the teacher , have pointed out all important aspects of the question in the previous discussion. To stop, respond with 'STOP' at the next turn. 7 You cannot; 8 - Directly give the answer to the student 9 - Include the correct option in your response , or any paraphrasing of the correct answer. 10 - Do not narrow down the options in your response. 11 12 Question: {question} 13 14 The previous discussion between you and the expert advisor is as follows; 15 {chat\_history} 16 {last\_student\_message} 17 18 Help the student find the correct answer by pointing out specific parts of the questions they need to think through , but do not include the correct phrase in your response. Your response should be no more than 3-4 sentences. If you have pointed out all challenging aspects of the question in the previous conversation , respond with "STOP" after the student 's next turn. 19 20 Response:
```

Prompt 16: Prompt for question-answering Researcher .

```
1 You are an expert doctor who is trying to select the answer to a medical question , and is willing to be open-minded about their answer. The questions are taken from a short -answer medical exam, and your role is to arrive at the correct answer. 2 3 You are chatting with an expert medical advisor , who will try to help you think through the problem , but will not directly tell you the answer. They will help you by pointing out aspects of the question that are important in finding the answer. Do not assume that the teacher knows the answer; only that they know how to think through the question. You can change your answer at any point, but do not assume that the expert knows the exact answer and is providing leading questions. Think about their guidance as a whole, and do not only respond to their last message 4 5 Question: {question} 6 7 The previous discussion between you and the expert advisor is as follows; 8 {chat\_history} 9 {last\_teacher\_message} 10 11 Rethink the question by considering what the teacher pointed out, in light of your original hypothesis. Remember they do not know the answer , but only how to think through the question. You can change your mind on the correct answer , but remember that unless the question explicitly asks for multiple answers , you can only provide a single answer. Respond with the option you believe most likely to be the right answer ("Answer:<SHORT ANSWER >") and a response to that message (" Response:<MESSAGE >"): 12 13 Answer:
```

Prompt 17: Prompt for question-answering Decider .

```
1 You are an expert doctor who is trying to select the answer to a medical question , and is willing to be open-minded about their answer. The questions are taken from a short -answer medical exam, and your role is to arrive at the correct answer. 2 3 You are chatting with an expert medical advisor , who will try to help you think through the problem , but will not directly tell you the answer. They will help you by pointing out aspects of the question that are important in finding the answer. Do not assume that the teacher knows the answer; only that they know how to think through the question. You can change your answer at any point, but do not assume that the expert knows the exact answer and is providing leading questions. Think about their guidance as a whole, and do not only respond to their last message 4 5 Question: {question} 6 7 The previous discussion between you and the expert advisor is as follows; 8 {chat\_history} 9 {last\_teacher\_message} 10 11 Rethink the question by considering what the teacher pointed out, in light of your original hypothesis. Remember they do not know the answer , but only how to think through the question. You can change your mind on the correct answer , but remember that unless the question explicitly asks for multiple answers , you can only provide a single answer. Respond with the option you believe most likely to be the right answer ("Answer:<SHORT ANSWER >") and a response to that message (" Response:<MESSAGE >"): 12 13 Answer:
```

Prompt 18: Prompt for question-answering final answer.

```
1 Assign a dxSimilarityScore to each of the following pairs where the first diagnosis is an "expectedDx" and the second diagnosis is the "providedDiagnosis". 2 3 Expected Vs Provided Dx Pairs: 4 {answer\_text} | {predicted\_answer\_text} 5 {answer\_text} | {zero\_shot\_option\_index} 6 7 Output each pair in one line using this format "dx1" "|" "dx2" "|" " dxSimilarityScore" 8 output:
```

Prompt 19: Prompt similar to that used for similarity score between generated and gold answers. Note that occasionally this outputs a number outside of 0-1. Unless these are all 100s we set these to 0s. This commonly occurs with math problems.

```
1 Question:{question} 2 3 Do the following two answers refer to the same medical concept? Respond with an answer ("Answer:True" or "Answer:False") followed by an explanation (" Explanation:") 4 5 {answer\_text} 6 {predicted\_answer\_text} 7 8 Answer:
```

Prompt 20: Prompt for exact matching between generated and gold answers.

